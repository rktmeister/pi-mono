Goal

 Build a first-class /handoff <goal> feature in pi (not just a prompt template), implemented as a high-fidelity handoff workflow that:
 - extracts relevant context from the current session branch (including tool calls/results, summaries, and file history),
 - generates a goal-conditioned draft prompt,
 - creates a new session linked via parentSession,
 - pre-fills the editor with the draft for review/submit.

 Constraints & Preferences

 - Prefer extension-based approach (uses ctx.sessionManager, avoids parsing JSONL via read truncation).
 - Handoff must be goal-conditioned (not “last N turns”), and must preserve early constraints/decisions.
 - Keep output bounded; drop noisy tool outputs first.
 - Avoid secrets leakage (don’t paste .env, tokens, private keys; redact if encountered).
 - Repo-specific constraint (pi-mono): after code changes run npm run check; never run npm run dev, npm run build, npm test (unless
 explicitly instructed).

 Progress

 ### Done

 - Investigated pi’s compaction + branch summarization behavior and how summaries are injected on /tree navigation
 (packages/coding-agent/src/core/agent-session.ts, packages/coding-agent/src/core/compaction/branch-summarization.ts).
 - Documented a refined implementation plan for a /handoff extension with goal-conditioned extraction and a two-pass “extract → compose”
 pipeline: docs/handoff-extension-plan.md.
 - Updated the prompt-template based fallback (~/agent-scripts/prompts/handoff.md) to produce a structured goal-conditioned handoff packet
 (useful while the extension is being built).

 ### In Progress

 - Implement `/handoff` as a project-local extension at `.pi/extensions/handoff.ts` (auto-discovered in this repo). Optional: symlink to `~/.pi/agent/extensions/handoff.ts` for global use.

 Key Decisions

 - Avoid JSONL parsing for handoff: Use ctx.sessionManager.getBranch() for full-fidelity history extraction.
 - Avoid “last N turns hard cap”: Use coverage + relevance anchoring (first user message, error turns, summaries, recent tail, goal matches)
 with budget allocation rather than pure recency.
 - Include tool calls/results only as curated “Operational Context”: keep commands + errors + stateful actions; avoid dumping logs.

 Operational Context

 - Reference implementation skeleton exists: `packages/coding-agent/examples/extensions/handoff.ts` (registers `/handoff`, generates prompt, opens editor, creates new session).
 - Recent upstream changes to keep in mind:
   - `/branch` was renamed to `/fork` (AgentSession API/events).
   - Branch summarization now appends custom focus to the default prompt (pattern worth copying).
 - Session plumbing is already available to extensions:
     - ctx.sessionManager.getBranch() for branch traversal
     - ctx.newSession({ parentSession }) for seamless new session creation
 - Branch summarization behavior (related idea): when navigating via /tree, pi summarizes entries from the abandoned leaf back to the common
 ancestor, then appends a branch_summary entry at the new leaf and injects it into context
 (packages/coding-agent/src/core/agent-session.ts:1881).

 Repo State

 - Branch: main
 - git status -sb shows ?? docs/ (the repo didn’t previously have a docs/ directory; plan doc is currently untracked).
 - No tracked diffs in this repo yet (only the untracked docs/ directory).
 - Prompt template updated outside repo: ~/agent-scripts/prompts/handoff.md (not tracked by pi-mono git).

 Next Steps

 1. Implement project-local extension at `.pi/extensions/handoff.ts` (auto-discovered here).
 2. Implement goal-conditioned extraction + two-pass pipeline per `docs/handoff-extension-plan.md` (anchors across full branch, curated operational context, file lists, budget enforcement).
 3. Relocate/track plan doc appropriately:
     - either add docs/ to repo intentionally, or move plan to packages/coding-agent/docs/ (if repo conventions prefer package-local docs).
 4. After code changes in pi-mono: run npm run check and fix all issues.
 5. Optional: update ~/agent-scripts/prompts/pickup.md to explicitly consume the handoff packet structure.

 Risks & Gotchas

 - Token budget reality: even without “N turns cap”, you still must bound inputs; implement budget allocation + drop order (noise first).
 - Tool-output noise: naive inclusion of tool results will swamp the handoff; only keep errors/diffs/identifiers.
 - Secrets: tool outputs may contain credentials; implement redaction rules.
 - Untracked docs/: docs/handoff-extension-plan.md is currently untracked; decide whether to commit/track/move later.
 - Export surface: if the extension wants to reuse file-op extraction helpers that aren’t exported publicly, either re-implement minimal
 extraction in the extension or promote helpers to a public API.

 <read-files>
 packages/coding-agent/docs/compaction.md
 packages/coding-agent/README.md
 packages/coding-agent/examples/extensions/handoff.ts
 packages/coding-agent/src/core/agent-session.ts
 packages/coding-agent/src/core/compaction/branch-summarization.ts
 packages/coding-agent/src/core/compaction/compaction.ts
 packages/coding-agent/src/core/prompt-templates.ts
 packages/coding-agent/src/core/session-manager.ts
 /home/definevera/agent-scripts/prompts/handoff.md
 /home/definevera/agent-scripts/prompts/pickup.md
 </read-files>
 <modified-files>
 docs/handoff-extension-plan.md
 /home/definevera/agent-scripts/prompts/handoff.md
 </modified-files>
